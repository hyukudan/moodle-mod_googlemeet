{{!
  This file is part of Moodle - http://moodle.org/

  Moodle is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  Moodle is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
}}
{{!
  @template mod_googlemeet/recordingstable

  Example context (json):
  {
    "recordings": [
      {
        "id": 1,
        "googlemeetid": 2,
        "name": "Session recording",
        "createdtime": 1605140304,
        "duration": "1:00:00",
        "webviewlink": "https://drive.google.com/file/d/xxx/view",
        "visible": 1,
        "createdtimeformatted": "Sunday, 23 April 2023, 1:47 PM"
      }
    ],
    "hasrecordings": true,
    "coursemoduleid": 1919,
    "hascapability": 1,
    "aienabled": 1,
    "cangenerateai": 1
  }
}}
<div id="googlemeet_recordings_table" class="googlemeet-recordings-container">
  <h4 class="googlemeet-section-title">{{# str }} recordings, mod_googlemeet {{/ str }}</h4>

  {{#hasrecordings}}
  <div class="googlemeet-recordings-list">
    {{#recordings}}
        <div class="googlemeet-recording-card {{^visible}}googlemeet-recording-hidden{{/visible}}" data-recordingid="{{id}}">
          {{^visible}}
            <div class="googlemeet-recording-hidden-badge">
              {{# str }} recording_hidden, mod_googlemeet {{/ str }}
            </div>
          {{/visible}}

          <div class="googlemeet-recording-content">
            <div class="googlemeet-recording-icon">
              <a href="{{webviewlink}}" target="_blank" class="googlemeet-play-btn" title="{{# str }} recording_watch, mod_googlemeet {{/ str }}">
                {{# pix }} play, mod_googlemeet {{/ pix }}
              </a>
            </div>

            <div class="googlemeet-recording-info">
              <div class="googlemeet-recording-name">
                <span class="recording-name-text">{{name}}</span>
                {{#hascapability}}
                  <a href="javascript:void(0);" class="recordingeditname googlemeet-edit-btn" data-id="{{id}}" title="{{# str }} edit {{/ str }}">
                    {{# pix }} i/edit, core {{/ pix }}
                  </a>
                {{/hascapability}}
              </div>
              <div class="googlemeet-recording-meta">
                <span class="googlemeet-recording-date">{{createdtimeformatted}}</span>
                <span class="googlemeet-recording-duration">{{duration}}</span>
              </div>
            </div>

            <div class="googlemeet-recording-actions">
              {{#hascapability}}
                <a href="javascript:void(0);" class="recordinghowhide googlemeet-visibility-btn" data-id="{{id}}">
                  {{#visible}}
                    {{# pix }} i/hide, core, {{# str }} hide, mod_googlemeet {{/ str }} {{/ pix }}
                  {{/visible}}
                  {{^visible}}
                    {{# pix }} i/show, core, {{# str }} show, mod_googlemeet {{/ str }} {{/ pix }}
                  {{/visible}}
                </a>
              {{/hascapability}}
              {{#aienabled}}
                <a href="javascript:void(0);" class="googlemeet-ai-toggle-btn" data-id="{{id}}" title="{{# str }} ai_analysis, mod_googlemeet {{/ str }}">
                  {{# pix }} i/report, core {{/ pix }}
                </a>
              {{/aienabled}}
            </div>
          </div>

          {{#aienabled}}
          <div class="googlemeet-ai-panel" data-recordingid="{{id}}" style="display: none;">
            <div class="googlemeet-ai-header">
              <h5>{{# str }} ai_analysis, mod_googlemeet {{/ str }}</h5>
              {{#cangenerateai}}
              <button class="btn btn-sm btn-primary googlemeet-ai-generate-btn" data-id="{{id}}">
                {{# str }} ai_generate, mod_googlemeet {{/ str }}
              </button>
              {{/cangenerateai}}
            </div>
            <div class="googlemeet-ai-content" data-recordingid="{{id}}">
              <div class="googlemeet-ai-loading" style="display: none;">
                {{# pix }} i/processing64, googlemeet {{/ pix }}
                <p>{{# str }} ai_generating, mod_googlemeet {{/ str }}</p>
              </div>
              <div class="googlemeet-ai-nodata">
                <p>{{# str }} ai_noanalysis, mod_googlemeet {{/ str }}</p>
              </div>
              <div class="googlemeet-ai-result" style="display: none;">
                <div class="googlemeet-ai-section googlemeet-ai-summary">
                  <h6>{{# str }} ai_summary, mod_googlemeet {{/ str }}</h6>
                  <div class="googlemeet-ai-summary-text"></div>
                </div>
                <div class="googlemeet-ai-section googlemeet-ai-keypoints">
                  <h6>{{# str }} ai_keypoints, mod_googlemeet {{/ str }}</h6>
                  <ul class="googlemeet-ai-keypoints-list"></ul>
                </div>
                <div class="googlemeet-ai-section googlemeet-ai-topics">
                  <h6>{{# str }} ai_topics, mod_googlemeet {{/ str }}</h6>
                  <div class="googlemeet-ai-topics-tags"></div>
                </div>
                <div class="googlemeet-ai-section googlemeet-ai-transcript">
                  <h6>
                    {{# str }} ai_transcript, mod_googlemeet {{/ str }}
                    <button class="btn btn-sm btn-link googlemeet-ai-copy-btn" data-id="{{id}}">
                      {{# str }} ai_copy_transcript, mod_googlemeet {{/ str }}
                    </button>
                  </h6>
                  <div class="googlemeet-ai-transcript-text"></div>
                </div>
                <div class="googlemeet-ai-meta">
                  <span class="googlemeet-ai-model"></span>
                  <span class="googlemeet-ai-date"></span>
                </div>
              </div>
              <div class="googlemeet-ai-error" style="display: none;">
                <div class="alert alert-danger"></div>
              </div>
            </div>
          </div>
          {{/aienabled}}
        </div>
    {{/recordings}}
  </div>
  {{/hasrecordings}}

  {{^hasrecordings}}
    <div class="googlemeet-no-recordings">
      <div class="googlemeet-no-recordings-icon">
        {{# pix }} i/empty, core {{/ pix }}
      </div>
      <p>{{# str }} thereisnorecordingtoshow, mod_googlemeet {{/ str }}</p>
    </div>
  {{/hasrecordings}}

  <div id="googlemeet_syncimg" class="googlemeet-loading-overlay">
    {{# pix }} i/processing64, googlemeet, {{# str }} loading, mod_googlemeet {{/ str }} {{/ pix }}
  </div>
</div>

{{#js}}
require([
  'jquery',
  'core/ajax',
  'core/notification'
], function($, Ajax, Notification) {

  $(document).ready(function() {
    {{#hascapability}}
      // Edit recording name
      $('.recordingeditname').on('click', function() {
        var card = $(this).closest('.googlemeet-recording-name');
        var text = card.find('.recording-name-text');
        var editBtn = $(this);
        var recordingid = $(this).attr('data-id');

        text.hide();
        editBtn.hide();

        var inputtext = document.createElement('input');
        inputtext.type = 'text';
        inputtext.className = 'form-control googlemeet-edit-input';
        inputtext.id = recordingid;
        inputtext.value = text.text().trim();
        inputtext.setAttribute('data-value', text.text().trim());
        inputtext.addEventListener('keydown', recordingeditkeydown);
        inputtext.addEventListener('focusout', recordingeditonfocusout);

        card.append(inputtext);
        inputtext.focus();
        inputtext.select();
      });

      function recordingeditkeydown(event) {
        var keyCode = event.which || event.keyCode;
        if (keyCode === 13) {
          event.preventDefault();
          event.currentTarget.removeEventListener('focusout', recordingeditonfocusout);
          recordingeditperform(event.currentTarget);
          return;
        }
        if (keyCode === 27) {
          event.currentTarget.removeEventListener('focusout', recordingeditonfocusout);
          recordingeditonfocusout(event.currentTarget);
        }
      }

      function recordingeditperform(element) {
        element = $(element);
        var card = element.closest('.googlemeet-recording-name');
        var text = card.find('.recording-name-text');
        var editBtn = card.find('.recordingeditname');

        var loading = $('<span class="googlemeet-inline-loading">{{# pix }} i/processing16, googlemeet, {{# str }} loading, mod_googlemeet {{/ str }} {{/ pix }}</span>');

        text.text(element.val()).show();
        element.hide();
        card.append(loading);

        Ajax.call([{
          methodname: 'mod_googlemeet_recording_edit_name',
          args: {
            recordingid: element.attr('id'),
            name: element.val(),
            coursemoduleid: {{ coursemoduleid }}
          }
        }])[0].then(function(response) {
          text.text(response.name).show();
          element.remove();
          loading.remove();
          editBtn.show();
        }).fail(Notification.exception).fail(function() {
          text.text(element.attr('data-value')).show();
          element.remove();
          loading.remove();
          editBtn.show();
        });
      }

      function recordingeditonfocusout(element) {
        if (element instanceof FocusEvent) {
          element = $(this);
        } else {
          element = $(element);
        }

        var card = element.closest('.googlemeet-recording-name');
        var text = card.find('.recording-name-text');
        var editBtn = card.find('.recordingeditname');
        element.remove();
        text.show();
        editBtn.show();
      }

      // Toggle visibility
      $('.recordinghowhide').on('click', function() {
        var btn = $(this);
        var recordingid = btn.attr('data-id');
        var card = btn.closest('.googlemeet-recording-card');
        var oldContent = btn.html();

        btn.html('{{# pix }} i/processing16, googlemeet, {{# str }} loading, mod_googlemeet {{/ str }} {{/ pix }}');

        Ajax.call([{
          methodname: 'mod_googlemeet_showhide_recording',
          args: {
            recordingid: recordingid,
            coursemoduleid: {{ coursemoduleid }}
          }
        }])[0].then(function(response) {
          if (response.visible) {
            btn.html('{{# pix }} i/hide, core, {{# str }} hide, mod_googlemeet {{/ str }} {{/ pix }}');
            card.removeClass('googlemeet-recording-hidden');
            card.find('.googlemeet-recording-hidden-badge').remove();
          } else {
            btn.html('{{# pix }} i/show, core, {{# str }} show, mod_googlemeet {{/ str }} {{/ pix }}');
            card.addClass('googlemeet-recording-hidden');
            if (!card.find('.googlemeet-recording-hidden-badge').length) {
              card.prepend('<div class="googlemeet-recording-hidden-badge">{{# str }} recording_hidden, mod_googlemeet {{/ str }}</div>');
            }
          }
        }).fail(Notification.exception).fail(function() {
          btn.html(oldContent);
        });
      });
    {{/hascapability}}

    {{#aienabled}}
      // Toggle AI panel
      $('.googlemeet-ai-toggle-btn').on('click', function() {
        var recordingid = $(this).attr('data-id');
        var panel = $('.googlemeet-ai-panel[data-recordingid="' + recordingid + '"]');

        if (panel.is(':visible')) {
          panel.slideUp(200);
        } else {
          // Load existing analysis if available
          loadAiAnalysis(recordingid);
          panel.slideDown(200);
        }
      });

      // Generate AI analysis
      $('.googlemeet-ai-generate-btn').on('click', function() {
        var recordingid = $(this).attr('data-id');
        generateAiAnalysis(recordingid, false);
      });

      // Copy transcript
      $('.googlemeet-ai-copy-btn').on('click', function() {
        var recordingid = $(this).attr('data-id');
        var transcriptText = $('.googlemeet-ai-content[data-recordingid="' + recordingid + '"] .googlemeet-ai-transcript-text').text();

        navigator.clipboard.writeText(transcriptText).then(function() {
          var btn = $('.googlemeet-ai-copy-btn[data-id="' + recordingid + '"]');
          var originalText = btn.text();
          btn.text('{{# str }} ai_copied, mod_googlemeet {{/ str }}');
          setTimeout(function() {
            btn.text(originalText);
          }, 2000);
        });
      });

      function loadAiAnalysis(recordingid) {
        var content = $('.googlemeet-ai-content[data-recordingid="' + recordingid + '"]');

        Ajax.call([{
          methodname: 'mod_googlemeet_get_ai_analysis',
          args: {
            recordingid: recordingid,
            coursemoduleid: {{ coursemoduleid }}
          }
        }])[0].then(function(response) {
          if (response.found && response.status === 'completed') {
            displayAiAnalysis(recordingid, response);
          } else if (response.found && response.status === 'processing') {
            content.find('.googlemeet-ai-nodata').hide();
            content.find('.googlemeet-ai-loading').show();
          } else if (response.found && response.status === 'failed') {
            showAiError(recordingid, response.error);
          }
        }).fail(function(ex) {
          console.error('Failed to load AI analysis:', ex);
        });
      }

      function generateAiAnalysis(recordingid, regenerate) {
        var content = $('.googlemeet-ai-content[data-recordingid="' + recordingid + '"]');
        var generateBtn = $('.googlemeet-ai-generate-btn[data-id="' + recordingid + '"]');

        content.find('.googlemeet-ai-nodata').hide();
        content.find('.googlemeet-ai-result').hide();
        content.find('.googlemeet-ai-error').hide();
        content.find('.googlemeet-ai-loading').show();
        generateBtn.prop('disabled', true).text('{{# str }} ai_generating, mod_googlemeet {{/ str }}');

        Ajax.call([{
          methodname: 'mod_googlemeet_generate_ai_analysis',
          args: {
            recordingid: recordingid,
            coursemoduleid: {{ coursemoduleid }},
            regenerate: regenerate
          }
        }])[0].then(function(response) {
          content.find('.googlemeet-ai-loading').hide();
          generateBtn.prop('disabled', false).text('{{# str }} ai_regenerate, mod_googlemeet {{/ str }}');

          if (response.status === 'completed') {
            displayAiAnalysis(recordingid, response);
          } else if (response.status === 'failed') {
            showAiError(recordingid, response.error);
          }
        }).fail(function(ex) {
          content.find('.googlemeet-ai-loading').hide();
          generateBtn.prop('disabled', false).text('{{# str }} ai_generate, mod_googlemeet {{/ str }}');
          showAiError(recordingid, ex.message || 'An error occurred');
        });
      }

      function displayAiAnalysis(recordingid, data) {
        var content = $('.googlemeet-ai-content[data-recordingid="' + recordingid + '"]');
        var result = content.find('.googlemeet-ai-result');

        content.find('.googlemeet-ai-nodata').hide();
        content.find('.googlemeet-ai-loading').hide();
        content.find('.googlemeet-ai-error').hide();

        // Summary
        result.find('.googlemeet-ai-summary-text').html(formatText(data.summary));

        // Key points
        var keypointsList = result.find('.googlemeet-ai-keypoints-list');
        keypointsList.empty();
        if (data.keypoints && data.keypoints.length > 0) {
          data.keypoints.forEach(function(point) {
            keypointsList.append('<li>' + escapeHtml(point) + '</li>');
          });
        }

        // Topics
        var topicsTags = result.find('.googlemeet-ai-topics-tags');
        topicsTags.empty();
        if (data.topics && data.topics.length > 0) {
          data.topics.forEach(function(topic) {
            topicsTags.append('<span class="badge badge-secondary googlemeet-ai-topic-badge">' + escapeHtml(topic) + '</span> ');
          });
        }

        // Transcript
        result.find('.googlemeet-ai-transcript-text').html(formatText(data.transcript));

        // Meta info
        if (data.aimodel) {
          result.find('.googlemeet-ai-model').text('Model: ' + data.aimodel);
        }
        if (data.timemodified) {
          var date = new Date(data.timemodified * 1000);
          result.find('.googlemeet-ai-date').text(date.toLocaleDateString());
        }

        result.show();

        // Update button text
        var generateBtn = $('.googlemeet-ai-generate-btn[data-id="' + recordingid + '"]');
        generateBtn.text('{{# str }} ai_regenerate, mod_googlemeet {{/ str }}');
      }

      function showAiError(recordingid, message) {
        var content = $('.googlemeet-ai-content[data-recordingid="' + recordingid + '"]');
        content.find('.googlemeet-ai-nodata').hide();
        content.find('.googlemeet-ai-loading').hide();
        content.find('.googlemeet-ai-result').hide();
        content.find('.googlemeet-ai-error').show().find('.alert').text(message);
      }

      function formatText(text) {
        if (!text) return '';
        return escapeHtml(text).replace(/\n/g, '<br>');
      }

      function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    {{/aienabled}}
  });
});
{{/js}}
