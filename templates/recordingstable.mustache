{{!
  This file is part of Moodle - http://moodle.org/

  Moodle is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  Moodle is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
}}
{{!
  @template mod_googlemeet/recordingstable

  Example context (json):
  {
    "recordings": [
      {
        "id": 1,
        "googlemeetid": 2,
        "name": "Session recording",
        "createdtime": 1605140304,
        "duration": "1:00:00",
        "webviewlink": "https://drive.google.com/file/d/xxx/view",
        "visible": 1,
        "createdtimeformatted": "Sunday, 23 April 2023, 1:47 PM"
      }
    ],
    "hasrecordings": true,
    "coursemoduleid": 1919,
    "hascapability": 1,
    "aienabled": 1,
    "cangenerateai": 1
  }
}}
<div id="googlemeet_recordings_table" class="googlemeet-recordings-container">
  <div class="googlemeet-recordings-header d-flex justify-content-between align-items-center flex-wrap mb-3">
    <h4 class="googlemeet-section-title mb-0">
      {{# str }} recordings, mod_googlemeet {{/ str }}
      {{#totalrecordings}}<span class="badge badge-secondary ml-2">{{totalrecordings}}</span>{{/totalrecordings}}
    </h4>

    {{#hasrecordings}}
    <div class="googlemeet-recordings-controls d-flex align-items-center">
      <label class="mr-2 mb-0 small text-muted">{{# str }} recordings_sort_by, mod_googlemeet {{/ str }}:</label>
      <div class="btn-group btn-group-sm" role="group">
        <a href="?id={{coursemoduleid}}&rorder=DESC&rpage=0"
           class="btn {{#isorderdesc}}btn-primary{{/isorderdesc}}{{^isorderdesc}}btn-outline-secondary{{/isorderdesc}}">
          {{# str }} recordingsorder_desc, mod_googlemeet {{/ str }}
        </a>
        <a href="?id={{coursemoduleid}}&rorder=ASC&rpage=0"
           class="btn {{#isorderasc}}btn-primary{{/isorderasc}}{{^isorderasc}}btn-outline-secondary{{/isorderasc}}">
          {{# str }} recordingsorder_asc, mod_googlemeet {{/ str }}
        </a>
      </div>
    </div>
    {{/hasrecordings}}
  </div>

  {{#hasrecordings}}
  {{#haspagination}}
  <div class="googlemeet-recordings-info small text-muted mb-2">
    {{# str }} recordings_showing, mod_googlemeet {{/ str }} {{start}} - {{end}} / {{totalrecordings}}
  </div>
  {{/haspagination}}
  <div class="googlemeet-recordings-list">
    {{#recordings}}
        <div class="googlemeet-recording-card {{^visible}}googlemeet-recording-hidden{{/visible}} {{#hasai}}googlemeet-recording-has-ai{{/hasai}}" data-recordingid="{{id}}">
          {{^visible}}
            <div class="googlemeet-recording-hidden-badge">
              {{# str }} recording_hidden, mod_googlemeet {{/ str }}
            </div>
          {{/visible}}

          <div class="googlemeet-recording-content">
            <div class="googlemeet-recording-icon">
              <a href="{{webviewlink}}" target="_blank" class="googlemeet-play-btn" title="{{# str }} recording_watch, mod_googlemeet {{/ str }}">
                {{# pix }} play, mod_googlemeet {{/ pix }}
              </a>
            </div>

            <div class="googlemeet-recording-info">
              <div class="googlemeet-recording-name">
                <span class="recording-name-text">{{name}}</span>
                {{#hasai}}
                  <span class="googlemeet-ai-badge" title="{{# str }} ai_analysis_available, mod_googlemeet {{/ str }}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 2L14.09 8.26L20.5 8.27L15.21 12.14L17.29 18.39L12 14.53L6.71 18.39L8.79 12.14L3.5 8.27L9.91 8.26L12 2Z" fill="currentColor"/>
                    </svg>
                    AI
                  </span>
                {{/hasai}}
                {{#hascapability}}
                  <a href="javascript:void(0);" class="recordingeditname googlemeet-edit-btn" data-id="{{id}}" title="{{# str }} edit {{/ str }}">
                    {{# pix }} i/edit, core {{/ pix }}
                  </a>
                {{/hascapability}}
              </div>
              <div class="googlemeet-recording-meta">
                <span class="googlemeet-recording-date">{{createdtimeformatted}}</span>
                <span class="googlemeet-recording-duration">{{duration}}</span>
                {{#hasai}}
                  <span class="googlemeet-recording-ai-info">
                    <span class="googlemeet-ai-keypoints-count">{{aikeypointscount}} {{# str }} ai_keypoints_short, mod_googlemeet {{/ str }}</span>
                  </span>
                {{/hasai}}
              </div>
            </div>

            <div class="googlemeet-recording-actions">
              {{#hascapability}}
                <a href="javascript:void(0);" class="recordinghowhide googlemeet-visibility-btn" data-id="{{id}}">
                  {{#visible}}
                    {{# pix }} i/hide, core, {{# str }} hide, mod_googlemeet {{/ str }} {{/ pix }}
                  {{/visible}}
                  {{^visible}}
                    {{# pix }} i/show, core, {{# str }} show, mod_googlemeet {{/ str }} {{/ pix }}
                  {{/visible}}
                </a>
                <a href="javascript:void(0);" class="googlemeet-ai-edit-btn" data-id="{{id}}" data-recordingname="{{name}}" title="{{# str }} ai_edit_manual, mod_googlemeet {{/ str }}">
                  {{# pix }} i/edit, core {{/ pix }}
                </a>
              {{/hascapability}}
              {{#aienabled}}
                <a href="javascript:void(0);" class="googlemeet-ai-toggle-btn {{#hasai}}googlemeet-ai-toggle-active{{/hasai}}" data-id="{{id}}" data-hasai="{{#hasai}}1{{/hasai}}{{^hasai}}0{{/hasai}}" title="{{# str }} ai_analysis, mod_googlemeet {{/ str }}">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L14.09 8.26L20.5 8.27L15.21 12.14L17.29 18.39L12 14.53L6.71 18.39L8.79 12.14L3.5 8.27L9.91 8.26L12 2Z" fill="currentColor"/>
                  </svg>
                </a>
              {{/aienabled}}
            </div>
          </div>

          {{! AI Preview Section - Shows summary and topics directly }}
          {{#aienabled}}
          {{#hasai}}
          <div class="googlemeet-ai-preview" data-recordingid="{{id}}">
            <div class="googlemeet-ai-preview-summary">
              <span class="googlemeet-ai-preview-label">{{# str }} ai_summary, mod_googlemeet {{/ str }}:</span>
              {{aisummarypreview}}
            </div>
            {{#aitopics.0}}
            <div class="googlemeet-ai-preview-topics">
              {{#aitopics}}
                <span class="googlemeet-ai-topic-tag">{{.}}</span>
              {{/aitopics}}
            </div>
            {{/aitopics.0}}
          </div>
          {{/hasai}}
          {{/aienabled}}

          {{! Expandable AI Panel }}
          {{#aienabled}}
          <div class="googlemeet-ai-panel" data-recordingid="{{id}}" style="display: none;">
            <div class="googlemeet-ai-header">
              <h5>{{# str }} ai_analysis, mod_googlemeet {{/ str }}</h5>
              <div class="googlemeet-ai-header-actions">
                {{#hasai}}
                  <span class="googlemeet-ai-generated-date">{{# str }} ai_generated_on, mod_googlemeet {{/ str }} {{aidate}}</span>
                {{/hasai}}
                {{#cangenerateai}}
                <button class="btn btn-sm btn-primary googlemeet-ai-generate-btn" data-id="{{id}}">
                  {{#hasai}}{{# str }} ai_regenerate, mod_googlemeet {{/ str }}{{/hasai}}
                  {{^hasai}}{{# str }} ai_generate, mod_googlemeet {{/ str }}{{/hasai}}
                </button>
                {{/cangenerateai}}
                {{#hascapability}}
                <button class="btn btn-sm btn-outline-secondary googlemeet-ai-edit-btn ml-1" data-id="{{id}}" data-recordingname="{{name}}" title="{{# str }} ai_edit_manual, mod_googlemeet {{/ str }}">
                  {{# pix }} i/edit, core {{/ pix }}
                  {{# str }} ai_edit_manual, mod_googlemeet {{/ str }}
                </button>
                {{/hascapability}}
              </div>
            </div>
            <div class="googlemeet-ai-content" data-recordingid="{{id}}" data-hasai="{{#hasai}}1{{/hasai}}{{^hasai}}0{{/hasai}}">
              <div class="googlemeet-ai-loading" style="display: none;">
                <div class="googlemeet-ai-loading-spinner"></div>
                <p>{{# str }} ai_generating, mod_googlemeet {{/ str }}</p>
              </div>
              {{^hasai}}
              <div class="googlemeet-ai-nodata">
                <div class="googlemeet-ai-nodata-icon">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L14.09 8.26L20.5 8.27L15.21 12.14L17.29 18.39L12 14.53L6.71 18.39L8.79 12.14L3.5 8.27L9.91 8.26L12 2Z" fill="currentColor" opacity="0.3"/>
                  </svg>
                </div>
                <p>{{# str }} ai_noanalysis, mod_googlemeet {{/ str }}</p>
                {{#cangenerateai}}
                <p class="googlemeet-ai-nodata-hint">{{# str }} ai_noanalysis_hint, mod_googlemeet {{/ str }}</p>
                {{/cangenerateai}}
              </div>
              {{/hasai}}
              {{#hasai}}
              <div class="googlemeet-ai-result">
                <div class="googlemeet-ai-section googlemeet-ai-summary">
                  <h6>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2ZM16 18H8V16H16V18ZM16 14H8V12H16V14ZM13 9V3.5L18.5 9H13Z" fill="currentColor"/>
                    </svg>
                    {{# str }} ai_summary, mod_googlemeet {{/ str }}
                  </h6>
                  <div class="googlemeet-ai-summary-text">{{aisummary}}</div>
                </div>
                <div class="googlemeet-ai-section googlemeet-ai-keypoints">
                  <h6>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M11 7H13V9H11V7ZM11 11H13V17H11V11ZM12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2Z" fill="currentColor"/>
                    </svg>
                    {{# str }} ai_keypoints, mod_googlemeet {{/ str }}
                    <span class="googlemeet-ai-count-badge">{{aikeypointscount}}</span>
                  </h6>
                  <ul class="googlemeet-ai-keypoints-list">
                    {{#aikeypoints}}
                      <li>{{.}}</li>
                    {{/aikeypoints}}
                  </ul>
                </div>
                <div class="googlemeet-ai-section googlemeet-ai-topics">
                  <h6>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7V17C3 18.1 3.9 18.99 5 18.99L16 19C16.67 19 17.27 18.67 17.63 18.16L22 12L17.63 5.84Z" fill="currentColor"/>
                    </svg>
                    {{# str }} ai_topics, mod_googlemeet {{/ str }}
                  </h6>
                  <div class="googlemeet-ai-topics-tags">
                    {{#aitopics}}
                      <span class="googlemeet-ai-topic-badge">{{.}}</span>
                    {{/aitopics}}
                  </div>
                </div>
                <div class="googlemeet-ai-section googlemeet-ai-transcript">
                  <h6>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM6 9H18V11H6V9ZM14 14H6V12H14V14ZM18 8H6V6H18V8Z" fill="currentColor"/>
                    </svg>
                    {{# str }} ai_transcript, mod_googlemeet {{/ str }}
                    <button class="btn btn-sm btn-link googlemeet-ai-copy-btn" data-id="{{id}}">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM19 21H8V7H19V21Z" fill="currentColor"/>
                      </svg>
                      {{# str }} ai_copy_transcript, mod_googlemeet {{/ str }}
                    </button>
                  </h6>
                  <div class="googlemeet-ai-transcript-text" data-recordingid="{{id}}">{{# str }} ai_transcript_loading, mod_googlemeet {{/ str }}</div>
                </div>
                <div class="googlemeet-ai-meta">
                  <span class="googlemeet-ai-model">{{# str }} ai_model, mod_googlemeet {{/ str }}: {{aimodel}}</span>
                </div>
              </div>
              {{/hasai}}
              <div class="googlemeet-ai-error" style="display: none;">
                <div class="alert alert-danger"></div>
              </div>
            </div>
          </div>
          {{/aienabled}}
        </div>
    {{/recordings}}
  </div>

  {{#haspagination}}
  <nav aria-label="Recordings pagination" class="googlemeet-pagination mt-3">
    <ul class="pagination pagination-sm justify-content-center mb-0">
      {{#hasprevious}}
      <li class="page-item">
        <a class="page-link" href="?id={{coursemoduleid}}&rpage={{previouspage}}&rorder={{currentorder}}">
          &laquo; {{# str }} recordings_page_previous, mod_googlemeet {{/ str }}
        </a>
      </li>
      {{/hasprevious}}
      {{^hasprevious}}
      <li class="page-item disabled">
        <span class="page-link">&laquo; {{# str }} recordings_page_previous, mod_googlemeet {{/ str }}</span>
      </li>
      {{/hasprevious}}

      {{#pages}}
      <li class="page-item {{#active}}active{{/active}}">
        {{#active}}
        <span class="page-link">{{number}}</span>
        {{/active}}
        {{^active}}
        <a class="page-link" href="?id={{coursemoduleid}}&rpage={{page}}&rorder={{currentorder}}">{{number}}</a>
        {{/active}}
      </li>
      {{/pages}}

      {{#hasnext}}
      <li class="page-item">
        <a class="page-link" href="?id={{coursemoduleid}}&rpage={{nextpage}}&rorder={{currentorder}}">
          {{# str }} recordings_page_next, mod_googlemeet {{/ str }} &raquo;
        </a>
      </li>
      {{/hasnext}}
      {{^hasnext}}
      <li class="page-item disabled">
        <span class="page-link">{{# str }} recordings_page_next, mod_googlemeet {{/ str }} &raquo;</span>
      </li>
      {{/hasnext}}
    </ul>
  </nav>
  {{/haspagination}}
  {{/hasrecordings}}

  {{^hasrecordings}}
    <div class="googlemeet-no-recordings">
      <div class="googlemeet-no-recordings-icon">
        {{# pix }} i/empty, core {{/ pix }}
      </div>
      <p>{{# str }} thereisnorecordingtoshow, mod_googlemeet {{/ str }}</p>
    </div>
  {{/hasrecordings}}

  <div id="googlemeet_syncimg" class="googlemeet-loading-overlay">
    {{# pix }} i/processing64, googlemeet, {{# str }} loading, mod_googlemeet {{/ str }} {{/ pix }}
  </div>

  {{! Modal for manual AI analysis editing }}
  <div class="modal fade" id="googlemeet-ai-edit-modal" tabindex="-1" role="dialog" aria-labelledby="googlemeet-ai-edit-modal-title" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="googlemeet-ai-edit-modal-title">{{# str }} ai_edit_manual_title, mod_googlemeet {{/ str }}</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="googlemeet-ai-edit-form">
            <input type="hidden" id="googlemeet-ai-edit-recordingid" value="">
            <div class="form-group">
              <label for="googlemeet-ai-edit-summary">{{# str }} ai_summary, mod_googlemeet {{/ str }}</label>
              <textarea class="form-control" id="googlemeet-ai-edit-summary" rows="4" placeholder="{{# str }} ai_edit_summary_placeholder, mod_googlemeet {{/ str }}"></textarea>
            </div>
            <div class="form-group">
              <label for="googlemeet-ai-edit-keypoints">{{# str }} ai_keypoints, mod_googlemeet {{/ str }}</label>
              <textarea class="form-control" id="googlemeet-ai-edit-keypoints" rows="6" placeholder="{{# str }} ai_edit_keypoints_placeholder, mod_googlemeet {{/ str }}"></textarea>
              <small class="form-text text-muted">{{# str }} ai_edit_keypoints_placeholder, mod_googlemeet {{/ str }}</small>
            </div>
            <div class="form-group">
              <label for="googlemeet-ai-edit-topics">{{# str }} ai_topics, mod_googlemeet {{/ str }}</label>
              <textarea class="form-control" id="googlemeet-ai-edit-topics" rows="2" placeholder="{{# str }} ai_edit_topics_placeholder, mod_googlemeet {{/ str }}"></textarea>
              <small class="form-text text-muted">{{# str }} ai_edit_topics_placeholder, mod_googlemeet {{/ str }}</small>
            </div>
            <div class="form-group">
              <label for="googlemeet-ai-edit-transcript">{{# str }} ai_transcript, mod_googlemeet {{/ str }}</label>
              <textarea class="form-control" id="googlemeet-ai-edit-transcript" rows="8" placeholder="{{# str }} ai_edit_transcript_placeholder, mod_googlemeet {{/ str }}"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">{{# str }} ai_edit_cancel, mod_googlemeet {{/ str }}</button>
          <button type="button" class="btn btn-primary" id="googlemeet-ai-edit-save">{{# str }} ai_edit_save, mod_googlemeet {{/ str }}</button>
        </div>
      </div>
    </div>
  </div>
</div>

{{#js}}
require([
  'jquery',
  'core/ajax',
  'core/notification'
], function($, Ajax, Notification) {

  $(document).ready(function() {
    {{#hascapability}}
      // Edit recording name
      $('.recordingeditname').on('click', function() {
        var card = $(this).closest('.googlemeet-recording-name');
        var text = card.find('.recording-name-text');
        var editBtn = $(this);
        var recordingid = $(this).attr('data-id');

        text.hide();
        editBtn.hide();

        var inputtext = document.createElement('input');
        inputtext.type = 'text';
        inputtext.className = 'form-control googlemeet-edit-input';
        inputtext.id = recordingid;
        inputtext.value = text.text().trim();
        inputtext.setAttribute('data-value', text.text().trim());
        inputtext.addEventListener('keydown', recordingeditkeydown);
        inputtext.addEventListener('focusout', recordingeditonfocusout);

        card.append(inputtext);
        inputtext.focus();
        inputtext.select();
      });

      function recordingeditkeydown(event) {
        var keyCode = event.which || event.keyCode;
        if (keyCode === 13) {
          event.preventDefault();
          event.currentTarget.removeEventListener('focusout', recordingeditonfocusout);
          recordingeditperform(event.currentTarget);
          return;
        }
        if (keyCode === 27) {
          event.currentTarget.removeEventListener('focusout', recordingeditonfocusout);
          recordingeditonfocusout(event.currentTarget);
        }
      }

      function recordingeditperform(element) {
        element = $(element);
        var card = element.closest('.googlemeet-recording-name');
        var text = card.find('.recording-name-text');
        var editBtn = card.find('.recordingeditname');

        var loading = $('<span class="googlemeet-inline-loading">{{# pix }} i/processing16, googlemeet, {{# str }} loading, mod_googlemeet {{/ str }} {{/ pix }}</span>');

        text.text(element.val()).show();
        element.hide();
        card.append(loading);

        Ajax.call([{
          methodname: 'mod_googlemeet_recording_edit_name',
          args: {
            recordingid: element.attr('id'),
            name: element.val(),
            coursemoduleid: {{ coursemoduleid }}
          }
        }])[0].then(function(response) {
          text.text(response.name).show();
          element.remove();
          loading.remove();
          editBtn.show();
        }).fail(Notification.exception).fail(function() {
          text.text(element.attr('data-value')).show();
          element.remove();
          loading.remove();
          editBtn.show();
        });
      }

      function recordingeditonfocusout(element) {
        if (element instanceof FocusEvent) {
          element = $(this);
        } else {
          element = $(element);
        }

        var card = element.closest('.googlemeet-recording-name');
        var text = card.find('.recording-name-text');
        var editBtn = card.find('.recordingeditname');
        element.remove();
        text.show();
        editBtn.show();
      }

      // Toggle visibility
      $('.recordinghowhide').on('click', function() {
        var btn = $(this);
        var recordingid = btn.attr('data-id');
        var card = btn.closest('.googlemeet-recording-card');
        var oldContent = btn.html();

        btn.html('{{# pix }} i/processing16, googlemeet, {{# str }} loading, mod_googlemeet {{/ str }} {{/ pix }}');

        Ajax.call([{
          methodname: 'mod_googlemeet_showhide_recording',
          args: {
            recordingid: recordingid,
            coursemoduleid: {{ coursemoduleid }}
          }
        }])[0].then(function(response) {
          if (response.visible) {
            btn.html('{{# pix }} i/hide, core, {{# str }} hide, mod_googlemeet {{/ str }} {{/ pix }}');
            card.removeClass('googlemeet-recording-hidden');
            card.find('.googlemeet-recording-hidden-badge').remove();
          } else {
            btn.html('{{# pix }} i/show, core, {{# str }} show, mod_googlemeet {{/ str }} {{/ pix }}');
            card.addClass('googlemeet-recording-hidden');
            if (!card.find('.googlemeet-recording-hidden-badge').length) {
              card.prepend('<div class="googlemeet-recording-hidden-badge">{{# str }} recording_hidden, mod_googlemeet {{/ str }}</div>');
            }
          }
        }).fail(Notification.exception).fail(function() {
          btn.html(oldContent);
        });
      });
    {{/hascapability}}

    {{#aienabled}}
      // Track loaded transcripts
      var loadedTranscripts = {};

      // Toggle AI panel
      $('.googlemeet-ai-toggle-btn').on('click', function() {
        var recordingid = $(this).attr('data-id');
        var hasai = $(this).attr('data-hasai') === '1';
        var panel = $('.googlemeet-ai-panel[data-recordingid="' + recordingid + '"]');
        var card = $(this).closest('.googlemeet-recording-card');

        if (panel.is(':visible')) {
          panel.slideUp(200);
          card.removeClass('googlemeet-ai-expanded');
        } else {
          // Load transcript on demand if we have AI data but haven't loaded transcript yet
          if (hasai && !loadedTranscripts[recordingid]) {
            loadTranscript(recordingid);
          }
          panel.slideDown(200);
          card.addClass('googlemeet-ai-expanded');
        }
      });

      // Click on preview also expands
      $('.googlemeet-ai-preview').on('click', function() {
        var recordingid = $(this).attr('data-recordingid');
        $('.googlemeet-ai-toggle-btn[data-id="' + recordingid + '"]').trigger('click');
      });

      // Generate AI analysis
      $('.googlemeet-ai-generate-btn').on('click', function() {
        var recordingid = $(this).attr('data-id');
        var content = $('.googlemeet-ai-content[data-recordingid="' + recordingid + '"]');
        var hasai = content.attr('data-hasai') === '1';
        generateAiAnalysis(recordingid, hasai);
      });

      // Copy transcript
      $('.googlemeet-ai-copy-btn').on('click', function(e) {
        e.stopPropagation();
        var btn = $(this);
        var recordingid = btn.attr('data-id');
        var transcriptText = $('.googlemeet-ai-transcript-text[data-recordingid="' + recordingid + '"]').text();

        navigator.clipboard.writeText(transcriptText).then(function() {
          var originalHtml = btn.html();
          btn.html('<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" fill="currentColor"/></svg> {{# str }} ai_copied, mod_googlemeet {{/ str }}');
          setTimeout(function() {
            btn.html(originalHtml);
          }, 2000);
        });
      });

      function loadTranscript(recordingid) {
        Ajax.call([{
          methodname: 'mod_googlemeet_get_ai_analysis',
          args: {
            recordingid: recordingid,
            coursemoduleid: {{ coursemoduleid }}
          }
        }])[0].then(function(response) {
          if (response.found && response.status === 'completed' && response.transcript) {
            $('.googlemeet-ai-transcript-text[data-recordingid="' + recordingid + '"]').html(formatText(response.transcript));
            loadedTranscripts[recordingid] = true;
          }
        }).fail(function(ex) {
          console.error('Failed to load transcript:', ex);
        });
      }

      function generateAiAnalysis(recordingid, regenerate) {
        var content = $('.googlemeet-ai-content[data-recordingid="' + recordingid + '"]');
        var generateBtn = $('.googlemeet-ai-generate-btn[data-id="' + recordingid + '"]');
        var card = $('.googlemeet-recording-card[data-recordingid="' + recordingid + '"]');
        var loadingEl = content.find('.googlemeet-ai-loading');

        content.find('.googlemeet-ai-nodata').hide();
        content.find('.googlemeet-ai-result').hide();
        content.find('.googlemeet-ai-error').hide();
        loadingEl.show();
        generateBtn.prop('disabled', true).text('{{# str }} ai_generating, mod_googlemeet {{/ str }}');

        // Show progress indicator with elapsed time
        var startTime = Date.now();
        var progressDots = 0;
        var progressInterval = setInterval(function() {
          progressDots = (progressDots + 1) % 4;
          var dots = '.'.repeat(progressDots);
          var elapsed = Math.floor((Date.now() - startTime) / 1000);
          var minutes = Math.floor(elapsed / 60);
          var seconds = elapsed % 60;
          var timeStr = minutes > 0 ? minutes + 'm ' + seconds + 's' : seconds + 's';
          loadingEl.find('p').html('{{# str }} ai_generating, mod_googlemeet {{/ str }}' + dots + '<br><small style="opacity: 0.7;">‚è± ' + timeStr + '</small>');
        }, 500);

        console.log('AI Analysis: Starting request for recording ' + recordingid);

        Ajax.call([{
          methodname: 'mod_googlemeet_generate_ai_analysis',
          args: {
            recordingid: recordingid,
            coursemoduleid: {{ coursemoduleid }},
            regenerate: regenerate
          },
          timeout: 180000 // 3 minutes timeout for AI processing
        }])[0].then(function(response) {
          clearInterval(progressInterval);
          var elapsed = Math.floor((Date.now() - startTime) / 1000);
          console.log('AI Analysis: Response received after ' + elapsed + 's', response);

          content.find('.googlemeet-ai-loading').hide();
          generateBtn.prop('disabled', false).text('{{# str }} ai_regenerate, mod_googlemeet {{/ str }}');

          if (response.status === 'completed') {
            displayAiAnalysis(recordingid, response, card, content);
          } else if (response.status === 'failed') {
            showAiError(recordingid, response.error || '{{# str }} ai_error_unknown, mod_googlemeet {{/ str }}');
          } else if (response.status === 'processing') {
            // Analysis is being processed in background
            showProcessingStatus(recordingid, content, generateBtn);
          } else {
            // Status is pending - show message
            showAiError(recordingid, '{{# str }} ai_status_pending, mod_googlemeet {{/ str }}');
          }
        }).fail(function(ex) {
          clearInterval(progressInterval);
          var elapsed = Math.floor((Date.now() - startTime) / 1000);
          console.error('AI Analysis: Failed after ' + elapsed + 's', ex);

          content.find('.googlemeet-ai-loading').hide();
          generateBtn.prop('disabled', false).text('{{# str }} ai_generate, mod_googlemeet {{/ str }}');

          var errorMsg = '';
          if (ex.message) {
            errorMsg = ex.message;
          } else if (ex.error) {
            errorMsg = ex.error;
          } else if (ex.errorcode) {
            errorMsg = 'Error: ' + ex.errorcode;
          } else {
            errorMsg = '{{# str }} ai_error_unknown, mod_googlemeet {{/ str }}';
          }

          // Add timeout hint if it took long
          if (elapsed >= 170) {
            errorMsg += ' (Timeout - the request took too long)';
          }

          showAiError(recordingid, errorMsg);
        });
      }

      function displayAiAnalysis(recordingid, data, card, content) {
        content.find('.googlemeet-ai-nodata').hide();
        content.find('.googlemeet-ai-loading').hide();
        content.find('.googlemeet-ai-error').hide();

        // Create or update result section
        var result = content.find('.googlemeet-ai-result');
        if (!result.length) {
          result = $('<div class="googlemeet-ai-result"></div>');
          content.append(result);
        }
        result.empty();

        // Summary section
        result.append(
          '<div class="googlemeet-ai-section googlemeet-ai-summary">' +
            '<h6><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2ZM16 18H8V16H16V18ZM16 14H8V12H16V14ZM13 9V3.5L18.5 9H13Z" fill="currentColor"/></svg> {{# str }} ai_summary, mod_googlemeet {{/ str }}</h6>' +
            '<div class="googlemeet-ai-summary-text">' + formatText(data.summary) + '</div>' +
          '</div>'
        );

        // Key points section
        var keypointsHtml = '<div class="googlemeet-ai-section googlemeet-ai-keypoints">' +
          '<h6><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11 7H13V9H11V7ZM11 11H13V17H11V11ZM12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2Z" fill="currentColor"/></svg> {{# str }} ai_keypoints, mod_googlemeet {{/ str }} <span class="googlemeet-ai-count-badge">' + (data.keypoints ? data.keypoints.length : 0) + '</span></h6>' +
          '<ul class="googlemeet-ai-keypoints-list">';
        if (data.keypoints && data.keypoints.length > 0) {
          data.keypoints.forEach(function(point) {
            keypointsHtml += '<li>' + escapeHtml(point) + '</li>';
          });
        }
        keypointsHtml += '</ul></div>';
        result.append(keypointsHtml);

        // Topics section
        var topicsHtml = '<div class="googlemeet-ai-section googlemeet-ai-topics">' +
          '<h6><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7V17C3 18.1 3.9 18.99 5 18.99L16 19C16.67 19 17.27 18.67 17.63 18.16L22 12L17.63 5.84Z" fill="currentColor"/></svg> {{# str }} ai_topics, mod_googlemeet {{/ str }}</h6>' +
          '<div class="googlemeet-ai-topics-tags">';
        if (data.topics && data.topics.length > 0) {
          data.topics.forEach(function(topic) {
            topicsHtml += '<span class="googlemeet-ai-topic-badge">' + escapeHtml(topic) + '</span>';
          });
        }
        topicsHtml += '</div></div>';
        result.append(topicsHtml);

        // Transcript section
        result.append(
          '<div class="googlemeet-ai-section googlemeet-ai-transcript">' +
            '<h6><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM6 9H18V11H6V9ZM14 14H6V12H14V14ZM18 8H6V6H18V8Z" fill="currentColor"/></svg> {{# str }} ai_transcript, mod_googlemeet {{/ str }} <button class="btn btn-sm btn-link googlemeet-ai-copy-btn" data-id="' + recordingid + '"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM19 21H8V7H19V21Z" fill="currentColor"/></svg> {{# str }} ai_copy_transcript, mod_googlemeet {{/ str }}</button></h6>' +
            '<div class="googlemeet-ai-transcript-text" data-recordingid="' + recordingid + '">' + formatText(data.transcript) + '</div>' +
          '</div>'
        );

        // Meta section
        result.append(
          '<div class="googlemeet-ai-meta">' +
            '<span class="googlemeet-ai-model">{{# str }} ai_model, mod_googlemeet {{/ str }}: ' + escapeHtml(data.aimodel || '') + '</span>' +
          '</div>'
        );

        result.show();
        loadedTranscripts[recordingid] = true;

        // Update card to show AI badge and preview
        card.addClass('googlemeet-recording-has-ai');
        var toggleBtn = card.find('.googlemeet-ai-toggle-btn');
        toggleBtn.addClass('googlemeet-ai-toggle-active');
        toggleBtn.attr('data-hasai', '1');
        content.attr('data-hasai', '1');

        // Add or update preview
        var preview = card.find('.googlemeet-ai-preview');
        var summaryPreview = data.summary ? (data.summary.length > 200 ? data.summary.substring(0, 200) + '...' : data.summary) : '';
        var previewHtml = '<div class="googlemeet-ai-preview" data-recordingid="' + recordingid + '">' +
          '<div class="googlemeet-ai-preview-summary"><span class="googlemeet-ai-preview-label">{{# str }} ai_summary, mod_googlemeet {{/ str }}:</span> ' + escapeHtml(summaryPreview) + '</div>';
        if (data.topics && data.topics.length > 0) {
          previewHtml += '<div class="googlemeet-ai-preview-topics">';
          data.topics.forEach(function(topic) {
            previewHtml += '<span class="googlemeet-ai-topic-tag">' + escapeHtml(topic) + '</span>';
          });
          previewHtml += '</div>';
        }
        previewHtml += '</div>';

        if (preview.length) {
          preview.replaceWith(previewHtml);
        } else {
          card.find('.googlemeet-recording-content').after(previewHtml);
        }

        // Add AI badge to name if not present
        var nameContainer = card.find('.googlemeet-recording-name');
        if (!nameContainer.find('.googlemeet-ai-badge').length) {
          nameContainer.find('.recording-name-text').after(
            '<span class="googlemeet-ai-badge" title="{{# str }} ai_analysis_available, mod_googlemeet {{/ str }}">' +
              '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                '<path d="M12 2L14.09 8.26L20.5 8.27L15.21 12.14L17.29 18.39L12 14.53L6.71 18.39L8.79 12.14L3.5 8.27L9.91 8.26L12 2Z" fill="currentColor"/>' +
              '</svg> AI' +
            '</span>'
          );
        }

        // Update keypoints count in meta
        var metaContainer = card.find('.googlemeet-recording-meta');
        var aiInfo = metaContainer.find('.googlemeet-recording-ai-info');
        var keypointsCount = data.keypoints ? data.keypoints.length : 0;
        if (aiInfo.length) {
          aiInfo.find('.googlemeet-ai-keypoints-count').text(keypointsCount + ' {{# str }} ai_keypoints_short, mod_googlemeet {{/ str }}');
        } else {
          metaContainer.append('<span class="googlemeet-recording-ai-info"><span class="googlemeet-ai-keypoints-count">' + keypointsCount + ' {{# str }} ai_keypoints_short, mod_googlemeet {{/ str }}</span></span>');
        }

        // Rebind click handler for new preview
        $('.googlemeet-ai-preview[data-recordingid="' + recordingid + '"]').on('click', function() {
          $('.googlemeet-ai-toggle-btn[data-id="' + recordingid + '"]').trigger('click');
        });

        // Rebind copy handler
        result.find('.googlemeet-ai-copy-btn').on('click', function(e) {
          e.stopPropagation();
          var btn = $(this);
          var rid = btn.attr('data-id');
          var transcriptText = $('.googlemeet-ai-transcript-text[data-recordingid="' + rid + '"]').text();
          navigator.clipboard.writeText(transcriptText).then(function() {
            var originalHtml = btn.html();
            btn.html('<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" fill="currentColor"/></svg> {{# str }} ai_copied, mod_googlemeet {{/ str }}');
            setTimeout(function() {
              btn.html(originalHtml);
            }, 2000);
          });
        });
      }

      function showAiError(recordingid, message) {
        var content = $('.googlemeet-ai-content[data-recordingid="' + recordingid + '"]');
        content.find('.googlemeet-ai-nodata').hide();
        content.find('.googlemeet-ai-loading').hide();
        content.find('.googlemeet-ai-result').hide();
        content.find('.googlemeet-ai-processing').hide();
        content.find('.googlemeet-ai-error').show().find('.alert').text(message);
      }

      function showProcessingStatus(recordingid, content, generateBtn) {
        content.find('.googlemeet-ai-nodata').hide();
        content.find('.googlemeet-ai-loading').hide();
        content.find('.googlemeet-ai-result').hide();
        content.find('.googlemeet-ai-error').hide();

        // Create or show processing message
        var processingEl = content.find('.googlemeet-ai-processing');
        if (!processingEl.length) {
          processingEl = $('<div class="googlemeet-ai-processing alert alert-info">' +
            '<div class="d-flex align-items-center">' +
              '<div class="spinner-border spinner-border-sm mr-2" role="status"></div>' +
              '<div>' +
                '<strong>{{# str }} ai_processing_background, mod_googlemeet {{/ str }}</strong><br>' +
                '<small>{{# str }} ai_processing_background_hint, mod_googlemeet {{/ str }}</small>' +
              '</div>' +
            '</div>' +
            '<button class="btn btn-sm btn-outline-primary mt-2 googlemeet-ai-refresh-btn" data-id="' + recordingid + '">' +
              '{{# str }} ai_check_status, mod_googlemeet {{/ str }}' +
            '</button>' +
          '</div>');
          content.append(processingEl);

          // Bind refresh button
          processingEl.find('.googlemeet-ai-refresh-btn').on('click', function() {
            checkAnalysisStatus(recordingid);
          });
        }
        processingEl.show();

        generateBtn.prop('disabled', true).text('{{# str }} ai_status_processing, mod_googlemeet {{/ str }}');

        // Start auto-refresh every 10 seconds
        var refreshInterval = setInterval(function() {
          checkAnalysisStatus(recordingid, function(status) {
            if (status !== 'processing') {
              clearInterval(refreshInterval);
            }
          });
        }, 10000);
      }

      function checkAnalysisStatus(recordingid, callback) {
        Ajax.call([{
          methodname: 'mod_googlemeet_get_ai_analysis',
          args: {
            recordingid: recordingid,
            coursemoduleid: {{ coursemoduleid }}
          }
        }])[0].then(function(response) {
          var content = $('.googlemeet-ai-content[data-recordingid="' + recordingid + '"]');
          var card = $('.googlemeet-recording-card[data-recordingid="' + recordingid + '"]');
          var generateBtn = $('.googlemeet-ai-generate-btn[data-id="' + recordingid + '"]');

          if (response.found && response.status === 'completed') {
            content.find('.googlemeet-ai-processing').hide();
            generateBtn.prop('disabled', false).text('{{# str }} ai_regenerate, mod_googlemeet {{/ str }}');
            displayAiAnalysis(recordingid, response, card, content);
          } else if (response.found && response.status === 'failed') {
            content.find('.googlemeet-ai-processing').hide();
            generateBtn.prop('disabled', false).text('{{# str }} ai_generate, mod_googlemeet {{/ str }}');
            showAiError(recordingid, response.error || '{{# str }} ai_error_unknown, mod_googlemeet {{/ str }}');
          }
          // Still processing - keep waiting

          if (callback) callback(response.status);
        }).fail(function(ex) {
          console.error('Failed to check status:', ex);
          if (callback) callback('error');
        });
      }

      function formatText(text) {
        if (!text) return '';
        return escapeHtml(text).replace(/\n/g, '<br>');
      }

      function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

    {{/aienabled}}

    {{#hascapability}}
      // Manual AI analysis editing
      $('.googlemeet-ai-edit-btn').on('click', function(e) {
        e.stopPropagation();
        var recordingid = $(this).attr('data-id');
        var recordingname = $(this).attr('data-recordingname');

        // Clear form
        $('#googlemeet-ai-edit-recordingid').val(recordingid);
        $('#googlemeet-ai-edit-summary').val('');
        $('#googlemeet-ai-edit-keypoints').val('');
        $('#googlemeet-ai-edit-topics').val('');
        $('#googlemeet-ai-edit-transcript').val('');

        // Update modal title with recording name
        $('#googlemeet-ai-edit-modal-title').text('{{# str }} ai_edit_manual_title, mod_googlemeet {{/ str }}: ' + recordingname);

        // Load existing data if available
        Ajax.call([{
          methodname: 'mod_googlemeet_get_ai_analysis',
          args: {
            recordingid: recordingid,
            coursemoduleid: {{ coursemoduleid }}
          }
        }])[0].then(function(response) {
          if (response.found && response.status === 'completed') {
            $('#googlemeet-ai-edit-summary').val(response.summary || '');
            $('#googlemeet-ai-edit-keypoints').val((response.keypoints || []).join('\n'));
            $('#googlemeet-ai-edit-topics').val((response.topics || []).join(', '));
            $('#googlemeet-ai-edit-transcript').val(response.transcript || '');
          }
        });

        // Show modal
        $('#googlemeet-ai-edit-modal').modal('show');
      });

      // Save AI analysis
      $('#googlemeet-ai-edit-save').on('click', function() {
        var btn = $(this);
        var recordingid = $('#googlemeet-ai-edit-recordingid').val();
        var summary = $('#googlemeet-ai-edit-summary').val();
        var keypoints = $('#googlemeet-ai-edit-keypoints').val();
        var topics = $('#googlemeet-ai-edit-topics').val();
        var transcript = $('#googlemeet-ai-edit-transcript').val();

        btn.prop('disabled', true).text('{{# str }} ai_edit_saving, mod_googlemeet {{/ str }}');

        Ajax.call([{
          methodname: 'mod_googlemeet_save_ai_analysis',
          args: {
            recordingid: parseInt(recordingid),
            coursemoduleid: {{ coursemoduleid }},
            summary: summary,
            keypoints: keypoints,
            topics: topics,
            transcript: transcript
          }
        }])[0].then(function(response) {
          btn.prop('disabled', false).text('{{# str }} ai_edit_save, mod_googlemeet {{/ str }}');
          if (response.success) {
            // Close modal and reload page to show updated data
            $('#googlemeet-ai-edit-modal').modal('hide');

            // Show success notification
            Notification.addNotification({
              message: '{{# str }} ai_edit_saved, mod_googlemeet {{/ str }}',
              type: 'success'
            });

            // Reload page after a short delay to show the notification
            setTimeout(function() {
              window.location.reload();
            }, 1000);
          }
        }).fail(function(ex) {
          btn.prop('disabled', false).text('{{# str }} ai_edit_save, mod_googlemeet {{/ str }}');
          Notification.exception(ex);
        });
      });
    {{/hascapability}}
  });
});
{{/js}}
